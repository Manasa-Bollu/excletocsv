stages:
  - process
  - deploy

track_excel_changes:
  stage: process
  image: python:3.9
  before_script:
    - pip install pandas openpyxl
    # Ensure the shell script is executable
    - chmod +x convert.sh
  script:
    # 1. Run the bash script which identifies ONLY changed files
    - ./convert.sh
  artifacts:
    paths:
      - version_history/
    expire_in: 1 week
  only:
    changes:
      - "*.xlsx"

sync_to_gitlab_repo:
  stage: deploy
  image: alpine:latest
  dependencies:
    - track_excel_changes
  before_script:
    - apk add git
  script:
    # 1. Setup git identity
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - git config --global user.name "$GITLAB_USER_NAME"
    
    # 2. Clone the target GitLab repository (using 'gitlab_sync' as the local folder)
    - git clone https://oauth2:${GL_TOKEN}@gitlab.com/minkumin/storecsv.git gitlab_sync
    
    # 3. Create the destination folder inside the CLONED repository folder
    # FIX: Changed 'github_sync' to 'gitlab_sync'
    - mkdir -p gitlab_sync/data_exports/
    
    # 4. Copy the contents of version_history/ into that specific folder
    # FIX: Changed 'github_sync' to 'gitlab_sync'
    - cp -a version_history/. gitlab_sync/data_exports/
    
    # 5. Push changes
    - cd gitlab_sync
    - git add .
    # Captures your exact Excel commit message
    - git commit -m "$CI_COMMIT_MESSAGE" || echo "No changes to commit"
    - git push origin main
  only:
    changes:
      - "*.xlsx"