stages:
  - process
  - deploy

track_excel_changes:
  stage: process
  image: python:3.9
  before_script:
    - pip install pandas openpyxl
    # Ensure the shell script is executable
    - chmod +x convert.sh
  script:
    # 1. Run the bash script which identifies ONLY changed files
    - ./convert.sh
  artifacts:
    paths:
      - version_history/
    expire_in: 1 week
  only:
    changes:
      - "*.xlsx"

sync_to_github:
  stage: deploy
  image: alpine:latest
  dependencies:
    - track_excel_changes
  before_script:
    - apk add git
  script:
    - git config --global user.email "Manasa.Bollu@bilvantis.io"
    - git config --global user.name "Manasa-Bollu"
    
    - git clone https://x-access-token:${GH_TOKEN}@github.com/Manasa-Bollu/storecsv.git github_sync
    
    # Use -a to preserve file structure and prevent errors if folder is empty
    - cp -a version_history/. github_sync/
    
    - cd github_sync
    - git add .
    - git commit -m "Auto-update changed files from GitLab [skip ci]" || echo "No changes to commit"
    - git push origin main
  only:
    changes:
      - "*.xlsx"